<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-lg p-6">
        <h2 class="text-xl font-bold mb-2 text-center text-blue-700">Student Panel</h2>
        <p class="text-sm text-center text-gray-600 mb-6">
            Welcome, <span class="font-semibold">{{ student.username }}</span>
        </p>
        <ul class="space-y-4">
            <li><a href="{{ url_for('routes.student_dashboard') }}" class="block font-semibold text-blue-600">Profile</a></li>
            <li><a href="{{ url_for('routes.student_assignments') }}" class="block hover:text-blue-500">Assignments</a></li>
            <li><a href="#" class="block hover:text-blue-500">Attendance</a></li>
            <li><a href="{{ url_for('routes.logout') }}" class="block text-red-600 hover:underline">Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-center mb-8">Student Dashboard</h2>

            <!-- Profile Picture -->
            <form method="POST" action="{{ url_for('routes.upload_student_photo') }}" enctype="multipart/form-data">
                <input type="hidden" name="cropped_image" id="cropped_image_input">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-28 h-28 rounded-full bg-gray-200 border-4 border-white shadow-md overflow-hidden relative">
                        <img id="profile-preview" src="{{ student.image_url or '' }}" alt="Profile Picture" class="object-cover w-full h-full">
                    </div>
                    <div class="mt-4 flex space-x-3">
                        <label for="select-image" class="bg-gray-300 text-gray-800 px-4 py-1 rounded cursor-pointer">Edit</label>
                        <input type="file" id="select-image" accept="image/*" class="hidden">
                        <button type="button" id="save-cropped" class="bg-blue-600 text-white px-4 py-1 rounded">Save Photo</button>
                    </div>
                </div>
            </form>

            <!-- Profile Info -->
            <form method="POST" action="{{ url_for('routes.update_student_profile') }}" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium mb-1">Name (from login)</label>
                        <input type="text" value="{{ student.username }}" disabled class="w-full border px-4 py-2 rounded bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Class</label>
                        <input type="text" name="class_name" value="{{ student.class_name }}" class="w-full border px-4 py-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Division</label>
                        <input type="text" name="division" value="{{ student.division }}" class="w-full border px-4 py-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Roll No</label>
                        <input type="text" name="roll_no" value="{{ student.roll_no }}" class="w-full border px-4 py-2 rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Bio</label>
                    <textarea name="bio" class="w-full border px-4 py-2 rounded" rows="3">{{ student.bio }}</textarea>
                </div>
                <div class="text-right">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cropper Modal -->
    <div id="cropperModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
        <div class="bg-white p-4 rounded shadow-lg max-w-xl">
            <div class="mb-4">
                <img id="cropper-image" class="max-w-full h-auto">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelCrop" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
                <button id="confirmCrop" class="bg-blue-600 text-white px-4 py-2 rounded">Crop</button>
            </div>
        </div>
    </div>

    <!-- JS: Cropper Logic -->
    <script>
        let cropper;
        const modal = document.getElementById('cropperModal');
        const cropperImage = document.getElementById('cropper-image');
        const selectImage = document.getElementById('select-image');
        const profilePreview = document.getElementById('profile-preview');

        selectImage.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && /^image\//.test(file.type)) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    cropperImage.src = event.target.result;
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        cropper = new Cropper(cropperImage, {
                            aspectRatio: 1,
                            viewMode: 1
                        });
                    }, 100);
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('cancelCrop').addEventListener('click', () => {
            cropper.destroy();
            modal.classList.add('hidden');
            selectImage.value = null;
        });

        document.getElementById('confirmCrop').addEventListener('click', () => {
            const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64data = reader.result;
                    profilePreview.src = base64data;
                    document.getElementById('cropped_image_input').value = base64data;
                    cropper.destroy();
                    modal.classList.add('hidden');
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
        });

        document.getElementById('save-cropped').addEventListener('click', () => {
            document.getElementById('cropped_image_input').form.submit();
        });
    </script>
</body>
</html>
