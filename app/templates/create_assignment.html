<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Assistant - Create Assignment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .chat-bubble { max-width: 80%; padding: 15px; border-radius: 15px; margin-bottom: 15px; animation: fadeIn 0.3s; }
        .bot-msg { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 2px; }
        .user-msg { background-color: #3b82f6; color: white; border-bottom-right-radius: 2px; margin-left: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 font-sans flex h-screen overflow-hidden">

    <aside class="w-64 bg-slate-800 text-white flex flex-col shadow-lg flex-shrink-0">
        <div class="p-6 text-center border-b border-slate-700"><h2 class="text-lg font-bold">Teacher Panel</h2></div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="/teacher/dashboard" class="block py-2.5 px-4 rounded hover:bg-slate-700 text-gray-300 hover:text-white"><i class="fas fa-user-circle w-6"></i> Profile</a>
            <a href="/teacher/create-assignment" class="block py-2.5 px-4 rounded bg-slate-700 text-white"><i class="fas fa-robot w-6"></i> AI Assistant</a>
            <a href="/teacher/assignments" class="block py-2.5 px-4 rounded hover:bg-slate-700 text-gray-300 hover:text-white"><i class="fas fa-list w-6"></i> View Assignments</a>
            <a href="/logout" class="block py-2.5 px-4 rounded hover:bg-red-600 mt-8"><i class="fas fa-sign-out-alt w-6"></i> Logout</a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full relative">
        <header class="bg-white shadow p-4 z-10 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-magic text-blue-500 mr-2"></i>Assignment Creation Assistant</h1>
            <a href="/teacher/dashboard" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i> Cancel</a>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4 pb-32">
            <div class="chat-bubble bot-msg shadow-sm">
                <p><strong><i class="fas fa-robot mr-2"></i>AI Assistant:</strong></p>
                <p class="mt-1">Hello! I'm here to help you create a new assignment.</p>
                <p class="mt-2">First, please fill in the <strong>Metadata</strong> below.</p>
            </div>

            <div id="metadata-form-container" class="chat-bubble bot-msg shadow-sm w-full max-w-lg bg-white border border-gray-200">
                <div class="space-y-3">
                    <input type="text" id="ui-title" placeholder="Assignment Title (e.g. Java Basics)" class="w-full p-2 border rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="ui-class" placeholder="Class (e.g. TY-CS)" class="w-full p-2 border rounded">
                        <input type="text" id="ui-div" placeholder="Division (e.g. A)" class="w-full p-2 border rounded">
                    </div>
                    <input type="text" id="ui-subject" placeholder="Subject (e.g. Java)" class="w-full p-2 border rounded">
                    <button onclick="lockMetadata()" class="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700">Next Step &rarr;</button>
                </div>
            </div>
        </div>

        <form id="real-form" action="/teacher/create-assignment" method="POST" enctype="multipart/form-data" class="hidden">
            <input type="text" name="title" id="real-title" required>
            <input type="text" name="class_name" id="real-class" required>
            <input type="text" name="division" id="real-div" required>
            <input type="text" name="subject_name" id="real-subject" required>
            <input type="file" name="questionnaire_file" id="real-file">
            <textarea name="ai_generated_key" id="real-key"></textarea>
        </form>

        <div id="action-area" class="bg-white p-4 border-t absolute bottom-0 w-full hidden">
            <div class="max-w-4xl mx-auto flex flex-col gap-4">

                <div class="flex items-center space-x-4">
                    <label class="flex-1 cursor-pointer bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-400 rounded-lg p-4 text-center transition">
                        <span id="upload-text" class="text-gray-600 font-medium"><i class="fas fa-cloud-upload-alt mr-2"></i>Upload Questionnaire (PDF/TXT)</span>
                        <input type="file" id="ui-file-input" accept=".txt,.pdf,.png,.jpg" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                </div>

                <div id="ai-controls" class="hidden flex gap-3">
                    <button onclick="generateKey()" id="btn-gen" class="flex-1 bg-purple-600 text-white py-2 rounded hover:bg-purple-700 shadow">
                        <i class="fas fa-brain mr-2"></i>Generate Answer Key with AI
                    </button>
                    <button onclick="submitAssignment()" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 shadow">
                        <i class="fas fa-check mr-2"></i>Finish & Create
                    </button>
                </div>

                <div id="ai-preview" class="hidden w-full">
                    <label class="text-xs font-bold text-gray-500">AI Generated Key:</label>
                    <textarea id="ui-key-preview" rows="4" class="w-full p-2 border rounded text-sm bg-gray-50" readonly></textarea>
                </div>
            </div>
        </div>

    </main>

    <script>
        function addMessage(html, isUser=false) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `chat-bubble ${isUser ? 'user-msg' : 'bot-msg'} shadow-sm`;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function lockMetadata() {
            const t = document.getElementById('ui-title').value;
            const c = document.getElementById('ui-class').value;
            const d = document.getElementById('ui-div').value;
            const s = document.getElementById('ui-subject').value;

            if(!t || !c || !d || !s) return alert("Please fill all fields.");

            document.getElementById('real-title').value = t;
            document.getElementById('real-class').value = c;
            document.getElementById('real-div').value = d;
            document.getElementById('real-subject').value = s;

            document.getElementById('metadata-form-container').classList.add('hidden');
            addMessage(`<p><strong>Metadata Set:</strong> ${t} (${c}-${d})</p>`, true);

            setTimeout(() => {
                addMessage(`<p><strong><i class="fas fa-robot mr-2"></i>AI Assistant:</strong></p><p>Great! Now upload the Questionnaire.</p>`);
                document.getElementById('action-area').classList.remove('hidden');
            }, 500);
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('upload-text').innerHTML = `<i class="fas fa-file-alt text-blue-500 mr-2"></i> ${file.name}`;

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('real-file').files = dataTransfer.files;

                document.getElementById('ai-controls').classList.remove('hidden');
                addMessage(`<p>Uploaded: <strong>${file.name}</strong></p>`, true);
            }
        }

        async function generateKey() {
            const btn = document.getElementById('btn-gen');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Thinking...`;
            btn.disabled = true;

            const fileInput = document.getElementById('real-file');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/teacher/generate-key', { method: 'POST', body: formData });
                const data = await response.json();

                if(data.error) throw new Error(data.error);

                document.getElementById('ui-key-preview').value = data.key;
                document.getElementById('real-key').value = data.key;
                document.getElementById('ai-preview').classList.remove('hidden');

                addMessage(`<p><strong><i class="fas fa-robot mr-2"></i>AI Assistant:</strong></p><p>Key generated! Click Finish to save.</p>`);

            } catch (e) {
                alert("AI Error: " + e.message);
            } finally {
                btn.innerHTML = `<i class="fas fa-brain mr-2"></i>Regenerate Key`;
                btn.disabled = false;
            }
        }

        function submitAssignment() {
            // DEBUG: Check if data exists before submitting
            const title = document.getElementById('real-title').value;
            const cls = document.getElementById('real-class').value;

            if(!title || !cls) {
                alert("Error: Assignment details are missing. Please refresh and fill the form again.");
                return;
            }
            document.getElementById('real-form').submit();
        }
    </script>
</body>
</html>